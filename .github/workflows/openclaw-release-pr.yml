name: Openclaw Release PR

on:
  schedule:
    - cron: "23 * * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update-pins:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v17

      - name: Update pins from upstream
        env:
          GH_TOKEN: ${{ github.token }}
          UPDATE_PINS_AUTOCOMMIT: "0"
          UPDATE_PINS_ALLOW_NO_BUILDABLE: "1"
          UPDATE_PINS_MAIN_CANDIDATES: "6"
          UPDATE_PINS_GC_BETWEEN_CANDIDATES: "1"
        run: scripts/update-pins.sh

      - name: Create or update pull request
        id: create_pr
        uses: peter-evans/create-pull-request@v7
        with:
          branch: chore/openclaw-pins-update
          delete-branch: true
          title: "chore: bump openclaw pins"
          commit-message: "chore: bump openclaw pins"
          body: |
            Automated pin update via `scripts/update-pins.sh`.

            - Script used: `scripts/update-pins.sh`

      - name: Summary
        run: |
          if [[ -n "${{ steps.create_pr.outputs.pull-request-url }}" ]]; then
            echo "Pull request: ${{ steps.create_pr.outputs.pull-request-url }}"
          else
            echo "No pin changes detected."
          fi
